<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>listeningto.io</title>
  <meta name="description" content="share playlists">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" sizes="32x32" href="./img/listeningto.png">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Raleway:wght@100&display=swap" rel="stylesheet">
</head>

<head>
  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
  </style>
</head>

<body>


  <header>
    <img src="img/listeningto.png" alt="">
    <h1>listeningto.io</h1>
  </header>
  <div class="container">
    <div id="login">
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
    </div>
  </div>

  <main>
    <div class="download">
    </div>
    <div class="songs">
    </div>
  </main>

  <script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
      </dl>
    </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    (function() {

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      var params = getHashParams();

      var access_token = params.access_token,
        refresh_token = params.refresh_token,
        error = params.error;

      if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {


          $.ajax({
            url: 'https://api.spotify.com/v1/me/top/artists?time_range=short_term&limit=6',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            success: function(response) {
              displayMostListened(response)
              $('#login').hide();
              $('#loggedin').show();
            }
          });
        } else {
          // render initial screen
          $('#login').show();
          $('#loggedin').hide();
        }

        function displayMostListened(result) {
          console.log(result);
          let albumArtwork = result.items.reduce((result, item, index) => {
            result += `<div class="albumArtwork"> <img src="${item.images[1].url}"alt="">
              <h4>${item.name}</h4>
              </div>`;
            return result;
          }, '');;
          let songsHtml = `<div class="songs">` + albumArtwork + `</div>`
          renderMostListened(songsHtml)
          $(".songs").html(albumArtwork);
        }

        function renderMostListened(html) {
          const API_ID = "7dd8b6b9-cd53-474e-85ff-2cecfe88b7f0"
          var settings = {
            "url": "https://hcti.io/v1/image",
            "method": "POST",
            "timeout": 0,
            "headers": {
              "Authorization": "Basic N2RkOGI2YjktY2Q1My00NzRlLTg1ZmYtMmNlY2ZlODhiN2YwOmQwY2FjN2Y0LTIyZmEtNDM3ZC1iMzc1LTI3ZmQ3ZDZiZDAxYw==",
              "Content-Type": "application/x-www-form-urlencoded"
            },
            "data": {
              "html": html,
              "css": `

              .songs {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                width: 500px;
              }

              .albumArtwork {
                width: 150px;
                height: 200px;
                border-style: solid;
                border-width: thin;
                margin: 10px;
                padding: 10px;
                font-family: 'Permanent Marker', cursive;
              }

              .albumArtwork img {
                float: left;
                background-size: cover;
                width: 150px;
                height: 150px;
              }

              .albumArtwork h4 {
                height: 70px;
                margin: auto;
                text-align: center;
              }

              .playlists label {
                display: block;
                border-style: solid;
                border-width: thin;
                margin: 10px 0px;
                padding: 10px;
              }

              .playlists input[type="radio"] {
                opacity: 0;
                position: fixed;
                width: 0;
              }

              .playlists input[type="radio"]:checked+label {
                background-color: #bfb;
              }

              .playlists input[type="radio"]:focus+label {
                background-color: #dfd;
              }

              .playlists label:hover, #quizForm label:checked {
                background-color: #dfd;
              }

              .playlists label:active {
                background-color: #dfd;
              }`,
              "google_fonts": "Permanent Marker"
            }
          }
          $.ajax(settings).done(function(response) {
            console.log(response);
            $(".songs").html(`<img id="artworkImg" src="${response.url}" width="500"/>`);
            $(".download").html(`<a href="${response.url}">Download and share</a>`);
          });
        }

      }
    })();
  </script>
</body>

</html>
